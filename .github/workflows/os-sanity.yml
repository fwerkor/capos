name: OS Sanity

on:
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: openwrt-sanity-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sanity:
    name: OpenWrt basic sanity
    runs-on: ubuntu-22.04
    timeout-minutes: 90

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install prerequisites
        shell: bash
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses-dev libssl-dev python3 python3-distutils python3-setuptools \
            rsync unzip zlib1g-dev file wget curl ca-certificates \
            perl pkg-config

      # 缓存能显著加速（dl、tools、toolchain、staging_dir）
      - name: Cache OpenWrt dirs
        uses: actions/cache@v4
        with:
          path: |
            dl
            build_dir
            staging_dir
            tmp
          key: openwrt-${{ runner.os }}-${{ hashFiles('feeds.conf', 'feeds.conf.default', 'scripts/feeds', 'include/version.mk', 'include/feeds.mk', 'rules.mk') }}
          restore-keys: |
            openwrt-${{ runner.os }}-

      - name: Feeds (update/install)
        shell: bash
        run: |
          set -euxo pipefail
          # feeds.conf 缺失会导致 feeds 工具无法运行；有 default 就复制一份
          if [ ! -f feeds.conf ] && [ -f feeds.conf.default ]; then
            cp feeds.conf.default feeds.conf
          fi
          if [ ! -f feeds.conf ]; then
            echo "# empty feeds config" > feeds.conf
          fi

          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Config/Kconfig sanity
        shell: bash
        run: |
          set -euxo pipefail
          # 不跑交互式 menuconfig，只验证 Kconfig/配置生成链路正常
          make defconfig

      - name: Package metadata sanity
        shell: bash
        run: |
          set -euxo pipefail
          # 这是 menuconfig/依赖扫描的核心阶段之一
          make -j"$(nproc)" prepare-tmpinfo V=s

      - name: Tools/toolchain sanity
        shell: bash
        run: |
          set -euxo pipefail
          # OpenWrt “基本功能”很大程度上体现在能不能把 host 工具链搭起来
          make -j"$(nproc)" tools/install V=s
          make -j"$(nproc)" toolchain/install V=s

      - name: Summary
        if: always()
        shell: bash
        run: |
          set -e
          echo "OpenWrt sanity finished."
          echo "Artifacts (if any):"
          ls -la bin 2>/dev/null || true
